---
- name: Verify
  hosts: windows-instance
  gather_facts: no

  vars:
    ansible_host: 10.100.30.79
    ansible_user: ansible-local
    ansible_password: Start123!
    ansible_connection: psrp
    ansible_psrp_auth: ntlm
    ansible_psrp_protocol: https
    ansible_psrp_cert_validation: ignore
    ansible_port: 5986

    event_log_name: "Application"
    event_source_name: "SAL9000-Event"
    event_log_name_all:
      - "Application"
      - "System"
      - "Security"
    event_log_max_size_kb: 51200

    defos_default_inbound_action: "block"
    defos_default_outbound_action: "allow"
    defos_log_allowed: false
    defos_log_ignored: false
    defos_log_blocked: true
    defos_log_max_size_kb: 16384
    defos_firewall_profiles:
      - profile: Domain
        log_file: "%SystemRoot%\\system32\\LogFiles\\Firewall\\domain_pfirewall.log"
      - profile: Private
        log_file: "%SystemRoot%\\system32\\LogFiles\\Firewall\\private_pfirewall.log"
      - profile: Public
        log_file: "%SystemRoot%\\system32\\LogFiles\\Firewall\\public_pfirewall.log"

    defos_utilize_ssl_time_data: 0
    defos_rdp_nla: true
    defos_admin_new_name: "WinAdmin"
    defos_guest_new_name: ""
    defos_guest_new_suffix: "-Guest"

  # collections:
  #   - ansible.windows
  #   - community.windows
  #   - chocolatey.chocolatey

  tasks:

    - name: Gather basic facts
      ansible.windows.setup:
      changed_when: false

    ####################################################################
    # 1) Check event log source exists
    ####################################################################
    - name: Check event source exists (modern API)
      ansible.windows.win_powershell:
        script: |
          try {
            $provider = Get-WinEvent -ListProvider "{{ event_source_name }}" -ErrorAction Stop
            return @{ Exists = $true }
          } catch {
            return @{ Exists = $false }
          }
      register: source_info
      changed_when: false

    - name: Assert event source exists
      assert:
        that:
          - source_info.output[0].Exists
        fail_msg: "Event source '{{ event_source_name }}' not found"

    ####################################################################
    # 2) Check UtilizeSslTimeData registry value
    ####################################################################
    - name: Read UtilizeSslTimeData
      ansible.windows.win_powershell:
        script: |
          try {
            $v = (Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\w32time\Config' -Name 'UtilizeSslTimeData' -ErrorAction SilentlyContinue).UtilizeSslTimeData
            return @{ Value = $v }
          } catch {
            return @{ Value = "error:$($_.Exception.Message)" }
          }
      register: check_ssl_time
      changed_when: false

    - name: Assert SSL time data equals expected value
      assert:
        that:
          - check_ssl_time.output[0].Value | string == defos_utilize_ssl_time_data | string
        fail_msg: "UtilizeSslTimeData not set to {{ defos_utilize_ssl_time_data }} (found: {{ check_ssl_time.output[0].Value }})"

    ####################################################################
    # 3) Check RDP enabled + NLA
    ####################################################################
    - name: Read fDenyTSConnections
      ansible.windows.win_powershell:
        script: |
          try {
            $v = (Get-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -ErrorAction SilentlyContinue).fDenyTSConnections
            return @{ Value = $v }
          } catch {
            return @{ Value = "error:$($_.Exception.Message)" }
          }
      register: check_rdp_flag
      changed_when: false

    - name: Assert RDP enabled (fDenyTSConnections = 0)
      assert:
        that:
          - check_rdp_flag.output[0].Value | string == '0'
        fail_msg: "RDP not enabled (found: {{ check_rdp_flag.output[0].Value }})"

    - name: Read UserAuthentication (NLA)
      ansible.windows.win_powershell:
        script: |
          try {
            $v = (Get-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name 'UserAuthentication' -ErrorAction SilentlyContinue).UserAuthentication
            return @{ Value = $v }
          } catch {
            return @{ Value = "error:$($_.Exception.Message)" }
          }
      register: check_nla
      changed_when: false

    - name: Assert NLA equals expected
      assert:
        that:
          - check_nla.output[0].Value | string == ((defos_rdp_nla | default(true)) | ternary('1','0'))
        fail_msg: "UserAuthentication incorrect (found: {{ check_nla.output[0].Value }})"

    ####################################################################
    # 4) Check Administrator rename
    ####################################################################
    - name: Determine Administrator account name
      ansible.windows.win_powershell:
        script: |
          $u = Get-LocalUser | Where-Object { $_.SID.Value -like '*-500' }
          return @{ Value = $u.Name }
      register: current_admin_name
      changed_when: false

    - name: Assert Administrator renamed
      assert:
        that:
          - current_admin_name.output[0].Value == defos_admin_new_name
        fail_msg: "Administrator not renamed (found: {{ current_admin_name.output[0].Value }})"

    ####################################################################
    # 5) Check Guest rename + disabled
    ####################################################################
    - name: Determine Guest account info
      ansible.windows.win_powershell:
        script: |
          $u = Get-LocalUser | Where-Object { $_.SID.Value -like '*-501' }
          if ($null -eq $u) {
            return @{ Name = ""; Enabled = "" }
          }
          return @{ Name = $u.Name; Enabled = $u.Enabled }
      register: guest_info
      changed_when: false

    - name: Assert Guest renamed and disabled
      assert:
        that:
          - guest_info.output[0].Name == (defos_guest_new_name if defos_guest_new_name != "" else ansible_env.COMPUTERNAME + defos_guest_new_suffix)
          - guest_info.output[0].Enabled | string == 'False'
        fail_msg: "Guest account incorrect: {{ guest_info.output[0] }}"

    ####################################################################
    # 6) Firewall profile checks
    ####################################################################
    - name: Verify firewall profiles
      ansible.windows.win_powershell:
        script: |
          $profiles = @('Domain','Private','Public')
          $errs = @()
          foreach ($p in $profiles) {
            $pf = Get-NetFirewallProfile -Name $p
            if ($pf.Enabled -ne $true) { $errs += "$p:disabled" }
            if ($pf.LogFileName -notlike '*pfirewall.log') { $errs += "$p:logpath:$($pf.LogFileName)" }
          }
          return @{ Value = ($errs -join ';') }
      register: check_fw_profiles
      changed_when: false

    - name: Assert firewall profiles OK
      assert:
        that:
          - check_fw_profiles.output[0].Value == ""
        fail_msg: "Firewall profile issues: {{ check_fw_profiles.output[0].Value }}"

    ####################################################################
    # 7) OpenSSH capability
    ####################################################################
    - name: Check OpenSSH capability
      ansible.windows.win_powershell:
        script: |
          try {
            $cap = Get-WindowsCapability -Online -Name 'OpenSSH.Server~~~~0.0.1.0' -ErrorAction Stop
            return @{ String = $cap.State.ToString() }
          } catch {
            return @{ String = "absent" }
          }
      register: ssh_cap
      changed_when: false

    - name: Assert OpenSSH installed
      assert:
        that:
          - "ssh_cap.output[0].String in ['Installed','Present','State: Installed','State: Present']"
        fail_msg: "OpenSSH capability not present/installed: {{ ssh_cap.output[0] }}"

    ####################################################################
    # 8) Verify PowerShellGet 2.x is installed and loading by default
    ####################################################################
    - name: Read PowerShellGet module info
      ansible.windows.win_powershell:
        script: |
          try {
            $mod = Get-Module PowerShellGet -ListAvailable | Sort-Object Version -Descending | Select-Object -First 1
            return @{
              Name    = $mod.Name
              Version = $mod.Version.ToString()
              Path    = $mod.ModuleBase
            }
          } catch {
            return @{
              Name    = "error"
              Version = "0"
              Path    = "error"
            }
          }
      register: psg_info
      changed_when: false

    - name: Assert PowerShellGet module is present
      assert:
        that:
          - psg_info.output[0].Name == 'PowerShellGet'
        fail_msg: "PowerShellGet module not found on system: {{ psg_info.output[0] }}"

    - name: Assert PowerShellGet version is 2.x or higher
      assert:
        that:
          - "(psg_info.output[0].Version is version('2.0.0', '>='))"
        fail_msg: "PowerShellGet version is too old (found: {{ psg_info.output[0].Version }})"

    - name: Assert PowerShellGet is loading from preferred module path
      assert:
        that:
          - "'Program Files' in psg_info.output[0].Path"
        fail_msg: "PowerShellGet is not loading from the preferred module path: {{ psg_info.output[0].Path }}"
