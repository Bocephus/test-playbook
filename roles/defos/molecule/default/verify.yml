---
- name: Verify
  hosts: windows-instance
  gather_facts: no
  vars:
    # Ansible connection and authentication details for the target Windows host. These should match the connection details used in molecule.yml and the expected configuration of your role.
    ansible_host: 10.100.30.79     # <-- REPLACE with your Windows host IP/hostname
    ansible_user: ansible-local    # <-- REPLACE with username
    ansible_password: Start123!    # <-- REPLACE with password
    ansible_connection: psrp
    ansible_psrp_auth: ntlm
    ansible_psrp_protocol: https
    ansible_psrp_cert_validation: ignore
    ansible_port: 5986

    # values should match your role defaults (or the values you pass when converging)
    event_log_name: "Application"
    event_source_name: "SAL9000-Event"
    event_log_name_all:
      - "Application"
      - "System"
      - "Security"
    event_log_max_size_kb: 51200

    # firewall & logging expectations
    defos_default_inbound_action: "block"
    defos_default_outbound_action: "allow"
    defos_log_allowed: false
    defos_log_ignored: false
    defos_log_blocked: true
    defos_log_max_size_kb: 16384
    defos_firewall_profiles:
      - profile: Domain
        log_file: "%SystemRoot%\\system32\\LogFiles\\Firewall\\domain_pfirewall.log"
      - profile: Private
        log_file: "%SystemRoot%\\system32\\LogFiles\\Firewall\\private_pfirewall.log"
      - profile: Public
        log_file: "%SystemRoot%\\system32\\LogFiles\\Firewall\\public_pfirewall.log"

    # timesync / rdp / account rename expectations
    defos_utilize_ssl_time_data: 0
    defos_rdp_nla: true
    defos_admin_new_name: "WinAdmin"
    defos_guest_new_name: ""
    defos_guest_new_suffix: "-Guest"
  collections:
    - ansible.windows
    - community.windows

  tasks:
    - name: Gather basic facts (for debug)
      ansible.windows.setup:
      register: _setup

    ####################################################################
    # 1) Check event log source exists (Application)
    ####################################################################
    - name: Check event source exists (modern API)
      ansible.windows.win_powershell:
        script: |
          try {
            $provider = Get-WinEvent -ListProvider "{{ event_source_name }}" -ErrorAction Stop
            return @{ SourceExists = $true }
          } catch {
            return @{ SourceExists = $false }
          }
      register: source_info

    - name: Assert event source exists
      ansible.builtin.assert:
        that:
          - source_info.output[0].SourceExists
        fail_msg: "Event source '{{ event_source_name }}' not found"

    # - name: Check FoG Event Logging source exists
    #   ansible.windows.win_powershell:
    #     script: |
    #       if ([System.Diagnostics.EventLog]::SourceExists('{{ event_source_name }}')) { Write-Output "present" } else { Write-Output "absent" }
    #   register: check_event_source
    # - name: Assert event source present orig
    #   assert:
    #     that:
    #       - check_event_source.stdout | default('') | trim == 'present'
    #     fail_msg: "FoG Event Logging source not found"

    ####################################################################
    # 2) Check UtilizeSslTimeData registry value
    ####################################################################
    - name: Read UtilizeSslTimeData via PowerShell
      ansible.windows.win_powershell:
        script: |
          try {
            $v = (Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\w32time\Config' -Name 'UtilizeSslTimeData' -ErrorAction SilentlyContinue).UtilizeSslTimeData
            if ($null -eq $v) { Write-Output "missing" } else { Write-Output $v }
          } catch {
            Write-Output "error:$($_.Exception.Message)"
          }
      register: check_ssl_time

    - name: Assert SSL time data equals expected value
      assert:
        that:
          - (check_ssl_time.stdout | default('') | trim) == (defos_utilize_ssl_time_data | string)
        fail_msg: "UtilizeSslTimeData not set to {{ defos_utilize_ssl_time_data }} (found: {{ check_ssl_time.stdout }})"

    ####################################################################
    # 3) Check RDP enabled (fDenyTSConnections = 0) and NLA setting
    ####################################################################
    - name: Read fDenyTSConnections
      ansible.windows.win_powershell:
        script: |
          $v = (Get-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -ErrorAction SilentlyContinue).fDenyTSConnections
          if ($null -eq $v) { Write-Output "missing" } else { Write-Output $v }
      register: check_rdp_flag
    - name: Assert RDP enabled (fDenyTSConnections = 0)
      assert:
        that:
          - (check_rdp_flag.stdout | default('')) | trim == '0'
        fail_msg: "RDP not enabled (fDenyTSConnections != 0)"

    - name: Read UserAuthentication (NLA)
      ansible.windows.win_powershell:
        script: |
          $v = (Get-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name 'UserAuthentication' -ErrorAction SilentlyContinue).UserAuthentication
          if ($null -eq $v) { Write-Output "missing" } else { Write-Output $v }
      register: check_nla
    - name: Assert NLA equals expected
      assert:
        that:
          - (check_nla.stdout | default('')) | trim == ( (1 if defos_rdp_nla | default(true) else 0) | string )
        fail_msg: "UserAuthentication doesn't match expected NLA setting"

    ####################################################################
    # 4) Check that Administrator account was renamed
    ####################################################################
    - name: Determine current Administrator account name (SID *-500)
      ansible.windows.win_powershell:
        script: |
          $u = Get-LocalUser | Where-Object { $_.SID.Value -like '*-500' }
          if ($null -eq $u) { Write-Output "" } else { Write-Output $u.Name }
      register: current_admin_name

    - name: Assert Administrator renamed to expected name
      assert:
        that:
          - (current_admin_name.stdout | default('') | trim) == defos_admin_new_name
        fail_msg: "Administrator account not renamed to {{ defos_admin_new_name }} (found: {{ current_admin_name.stdout }})"

    ####################################################################
    # 5) Check Guest account renamed and disabled
    ####################################################################
    - name: Determine current Guest account (SID *-501)
      ansible.windows.win_powershell:
        script: |
          $u = Get-LocalUser | Where-Object { $_.SID.Value -like '*-501' }
          if ($null -eq $u) { Write-Output "" } else { Write-Output ($u.Name + '|' + ($u.Enabled -as [string])) }
      register: guest_info

    - name: Assert Guest renamed and disabled (if configured)
      assert:
        that:
          - (guest_info.stdout | default('') | split('\\|')[0] | trim) == ( "{{ (defos_guest_new_name if defos_guest_new_name != '' else (ansible_env.COMPUTERNAME + defos_guest_new_suffix)) }}" )
          - (guest_info.stdout | default('') | split('\\|')[1] | trim) == 'False'
        fail_msg: "Guest account name or enabled state not as expected: {{ guest_info.stdout }}"

    ####################################################################
    # 6) Check firewall profiles enabled and logging file set
    ####################################################################
    - name: Verify firewall profile settings via PowerShell
      ansible.windows.win_powershell:
        script: |
          $profiles = @('Domain','Private','Public')
          $errs = @()
          foreach ($p in $profiles) {
            $pf = Get-NetFirewallProfile -Name $p
            if ($pf.Enabled -ne $true) { $errs += "$p:disabled" }
            # check LogFileName
            if ($pf.LogFileName -notlike '*pfirewall.log') { $errs += "$p:logpath:$($pf.LogFileName)" }
          }
          if ($errs.Count -eq 0) { Write-Output "ok" } else { Write-Output ($errs -join ';') }
      register: check_fw_profiles

    - name: Assert firewall profiles pass checks
      assert:
        that:
          - (check_fw_profiles.stdout | default('')) | trim == 'ok'
        fail_msg: "Firewall profile checks failed: {{ check_fw_profiles.stdout }}"

    ####################################################################
    # 7) Verify OpenSSH capability present (if applied)
    ####################################################################
    - name: Check OpenSSH.Server capability present
      ansible.windows.win_powershell:
        script: |
          $cap = Get-WindowsCapability -Online -Name 'OpenSSH.Server~~~~0.0.1.0' -ErrorAction SilentlyContinue
          if ($null -eq $cap) { Write-Output 'absent' } else { Write-Output $cap.State }
      register: ssh_cap
    - name: Assert OpenSSH server installed or state Present
      assert:
        that:
          - "(ssh_cap.stdout | default('') | trim) in ['Installed', 'Present', 'State: Installed', 'State: Present']"
        fail_msg: "OpenSSH capability not present/installed: {{ ssh_cap.stdout }}"
